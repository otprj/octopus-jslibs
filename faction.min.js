!function(t,e){if("function"==typeof define&&define.amd)define(["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var i={exports:{}};e(i.exports),t.faction=i.exports}}(this,function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t){return new Promise(function(e,i){var n=document.createElement("script");n.async="async",n.addEventListener("load",function(){e()},!1),n.src=t,document.getElementsByTagName("head")[0].appendChild(n)})}function n(){return s?s:window.createjs?(s||(createjs.LoadItem.LOAD_TIMEOUT_DEFAULT=8e5,createjs.MotionGuidePlugin.install(),s=Promise.resolve()),s):s=i(o.motionLibUrl).then(function(){createjs.MotionGuidePlugin.install()})}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),o=Object.create(HTMLElement.prototype);o.motionLibUrl="//code.createjs.com/createjs-2015.11.26.min.js",Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,i=Object(this),n=i.length>>>0,a=arguments[1],o=0;o<n;o++)if(e=i[o],t.call(a,e,o,i))return e}),o.createdCallback=function(){this._loadCount=0,this._appliedScale=null,this._bitmaps={},this._sprites={},this.readAttributes()},o.scaleModifier=window.metadata?window.metadata.factionScaleModifier||"@":"@",o.readAttributes=function(){null!=this.getAttribute("record")?(this.record=this.getRecordFromAttrVal(this.getAttribute("record")),this.base=this.record.base,this.name=this.record.name):(this.base=this.getAttribute("base"),this.name=this.getAttribute("name")),this.kind=this.getAttribute("kind")||"image",this.scaleModifier=this.getAttribute("scale-modifier");var t=this.getAttribute("stay");null!=t&&(t=""===t||"true"===t?0:parseInt(t),this._stayPosition=t)},o.getRecordFromAttrVal=function(t){return"{"==typeof t[0]?JSON.parse(t):this.findRecordById(t)},o.findRecordById=function(t){return window.metadata&&window.metadata.factions?window.metadata.factions.find(function(e){return e.id==t}):{}},o.findRecordByBaseAndName=function(t,e){return window.metadata&&window.metadata.factions?window.metadata.factions.find(function(i){return i.base==t&&i.name==e}):{}},o.attributeChangedCallback=function(t,e,i){if(!(this._loadCount<=0)){$(this);switch(t){case"record":$(this).empty(),this.load();break;case"base":$(this).empty(),this.load();break;case"name":$(this).empty(),this.load();break;case"kind":$(this).empty(),this._oldKind=this.kind,this.kind=i,this.load();break;case"stay":this._stayPosition=i,null!=i&&(i=""===i||"true"===i?0:parseInt(i),this._stayPosition=i)}}};var s,r=parseInt(window.devicePixelRatio||1);o.getSuitableImageScale=function(){for(var t=this.record.image,e=getComputedStyle(this),i=parseFloat(e.width),n=(parseFloat(e.height),0),a=t.scales.length;n<a;n++){var o=t.scales[n];Math.ceil(o*t.width/r/100);if(!(n<a-1))return o;var s=t.scales[n+1],d=Math.ceil(s*t.width/r/100);if(d-i<-1)return o}},o.getMotionStageScale=function(){var t=this.record.motion,e=r,i=$(this),n=i.width(),a=i.height(),o=e*n*(t.scale||100),s=e*a*(t.scale||100);return Math.max(o/t.stage.width,s/t.stage.height)},o.play=function(t,e){switch(this.kind){case"motion":this.scene&&(void 0!==t?this.scene.gotoAndPlay&&this.scene.gotoAndPlay(t):this.scene.play&&this.scene.play());break;default:console.warn("Not supported play function in this kind:",this.kind)}},o.stop=function(t){switch(this.kind){case"motion":this.scene&&this.scene.gotoAndStop&&this.scene.gotoAndStop(t);break;default:console.warn("Not supported stop function in this kind:",this.kind)}},o.load=function(t){this.readAttributes();var e=$(this),i=this;return t&&!t(e)?Promise.resolve():(this._loadCount+=1,this.record||(this.record=this.findRecordByBaseAndName(this.base,this.name)),new Promise(function(t,n){switch(i.kind){case"image":var a=i.getSuitableImageScale();if(i._appliedScale>=a&&(i.kind==i._oldKind||!i._oldKind))return void t();i._appliedScale=a,e.children().filter(".otp-canvas").attr("otp-state","retired");var o=$('<img class="otp-canvas otp-image-canvas">'),s=i.getImageUrl(i.base,i.name,a,i.record.image.ext);o.on("load",function(){e.children().filter(".otp-canvas[otp-state=retired]").remove(),t()}).on("error",function(){t()}).attr({src:s}),e.prepend(o);break;case"background":var a=i.getSuitableImageScale();if(i._appliedScale>=a&&(i.kind==i._oldKind||!i._oldKind))return void t();var o=$("<img>"),s=i.getImageUrl(i.base,i.name,a,i.record.image.ext);o.on("load",function(){t()}).on("error",function(){t()}).attr({src:s}),e.css({"background-image":"url("+s+")"}),i._appliedScale=a;break;case"motion":var r=i.record.motion;if(r&&r.stage){var d=i.getMotionStageScale();if(i._appliedScale>=d&&(i.kind==i._oldKind||!i._oldKind))return void t();var c=e.find(".otp-motion-canvas");if(c.length>0)if(c.attr({width:Math.round(r.stage.width*d/100),height:Math.round(r.stage.height*d/100),"otp-stage-width":r.stage.width,"otp-stage-height":r.stage.height}),100*i.stage.scaleX>=d)i.stage.scaleX=i.stage.scaleY=d/100;else{i.stage.scaleX=i.stage.scaleY=d/100;var l=i._loadCount;i.loadUpdatedMotionImages(i.record,d).then(function(t){if(!(i._loadCount>l))for(var e=0,n=t.length;e<n;e++){var a=t[e],o=i.record.motion.images[a.id],s=new createjs.Event("changed");if(i.record.motion.atlases){var r=i.record.motion.atlases[a.id];if(r){var d=i._sprites[a.id],c=o.ewidth/a.img.width,h={images:{},frames:i.getScaledFramesBounds(r.frames,1/c)};h.images.push(a.img),d.spriteSheet=new createjs.SpriteSheet(h),s.set({scale:c}),d.dispatchEvent(s)}}else{var f=i._bitmaps[a.id],c=o.ewidth/a.img.width;f.image=a.img,s.set({scale:c}),f.dispatchEvent(s)}}})}else i._motionLoading||(e.children().filter(".otp-canvas").attr("otp-state","retired"),i.loadMotion(i.record,d).then(function(){e.children().filter(".otp-canvas[otp-state=retired]").remove();var n=$('<canvas class="otp-canvas otp-motion-canvas">').attr({width:Math.round(r.stage.width*d/100),height:Math.round(r.stage.height*d/100),"otp-stage-width":r.stage.width,"otp-stage-height":r.stage.height}).appendTo(e);i.stage=new createjs.Stage(n[0]),i.scene=new(r.library[i.name.replace(/\-/g,"")]),i.stage.addChild(i.scene),i.stage.scaleX=i.stage.scaleY=d/100,i.stage.update(),createjs.Ticker.addEventListener("tick",i.stage),void 0!=i._stayPosition&&i.stop(i._stayPosition),t()}));i._appliedScale=d}else console.error("ERROR: Not found stage object:",i.base);break;default:console.error("Not support faction kind:",i.kind)}}))},o.loadMotionLibs=function(){return this._motionLibsPromise||(this.record.motion.initLibrary?this._motionLibsPromise=Promise.all([n()]):this._motionLibsPromise=Promise.all([n(),i(this.getMotionLibUrl(this.base,this.name))])),this._motionLibsPromise},o.loadUpdatedMotionImages=function(t,e){var i=[],n=this;return new Promise(function(a,o){for(var s=0,r=n._motionManifest.length;s<r;s++){var d=n._motionManifest[s],c=n.getMotionManifestItem(t,d.id,e);d.scale<c.scale&&i.push(c)}if(i.length>0)for(var l=0,h=i.length,f=function(t){var e=new Image;e.addEventListener("load",function(){n._motionManifest[n._motionManifest.indexOf(n.findMotionMftItem(t.id))]=t,t.img=this,++l==h&&a(i)},!1),e.src=t.src},s=0,r=i.length;s<r;s++)f(i[s]);else a([])})},o.buildMotionManifest=function(t,e){var i=[];for(var n in t.motion.images)i.push(this.getMotionManifestItem(t,n,e));return i},o.getMotionManifestItem=function(t,e,i){for(var n=t.motion.images[e],a=n.scales,o=100,s=(n.width,i*n.ewidth/100),r=0,d=a.length;r<d;r++){var c=a[r],l=a[r+1];if(null==l||l*n.width/100-s<-1){o=c;break}}return{src:this.getImageUrl(this.base+"/"+this.name+".anim",e,o,n.ext),id:e,scale:o}},o.getImageUrl=function(t,e,i,n){return"/"!=t[t.length-1]&&t.length>0&&(t+="/"),""+t+e+(this.scaleModifier||o.scaleModifier)+i+"p"+n},o.getMotionLibUrl=function(t,e){return"/"==t[t.length-1]&&(t=t.substring(0,t.length-1)),t+"/"+e+".anim/"+e+".js"},o.buildBitmapDefine=function(t,e,i,n,a){var o=new createjs.Bitmap(n),s=new createjs.MovieClip;o.nominalBounds=s.nominalBounds=new(Function.prototype.bind.call(createjs.Rectangle,null,i)),this._bitmaps[e]=o;var r=function(){};r.prototype=o,(t[e]=function(){var t=new r;t.setTransform(0,0,a,a),o.addEventListener("changed",function(e){t.setTransform(0,0,e.scale/a,e.scale/a)}),this.addChild(t)}).prototype=s},o.buildSpriteDefine=function(t,e,i,n,a){var o=new createjs.Sprite,s=new createjs.MovieClip;this._sprites[e]=o;var r=function(){this.spriteSheet=n,this.gotoAndStop(i)};r.prototype=o,(t[e]=function(){var t=new r;t.setTransform(0,0,a,a),this.addChild(t),o.addEventListener("changed",function(e){t.setTransform(0,0,e.scale,e.scale)})}).prototype=s},o.findMotionMftItem=function(t){for(var e,i=0,n=this._motionManifest.length;i<n;i++){var a=this._motionManifest[i];if(a.id==t){e=a;break}}return e},o.getScaledFramesBounds=function(t,e){for(var i=[],n=0,a=t.length;n<a;n++){var o=t[n];i.push([o[0]*e,o[1]*e,o[2]*e,o[3]*e])}return i},o.loadMotion=function(t,e){if(this._motionPromise)return this._motionPromise;var i=this;return i._motionLoading=!0,this._motionPromise=new Promise(function(n,a){i.loadMotionLibs().then(function(){var o=t.motion,s=o.library,r=(s.properties,{}),d={},c=new createjs.LoadQueue((!1)),l=function(){if(i._motionLoading=!1,o.atlases)for(var t in o.atlases){var e=o.atlases[t],a=(e.sprites,i.findMotionMftItem(t)),l=o.images[t],h=l.width*a.scale/100/l.ewidth,f={images:[c.getResult(a.id)],frames:i.getScaledFramesBounds(e.frames,h)};d[t]=new createjs.SpriteSheet(f);for(var u=o.atlases[t].sprites,m=0,g=u.length;m<g;m++)i.buildSpriteDefine(s,u[m],m,d[t],1/h)}else{for(var m=0,g=i._motionManifest.length;m<g;m++){var a=i._motionManifest[m];r[a.id]=c.getResult(a.id)}if(o.bitmaps)for(var t in o.bitmaps){var a=i.findMotionMftItem(t),l=o.images[t],h=l.width*a.scale/100/l.ewidth;i.buildBitmapDefine(s,t,o.bitmaps[t].bounds,r[t],1/h)}}o.initLibrary(s,createjs),n()};i._motionManifest=i.buildMotionManifest(t,e),i._motionManifest.length>0?(c.loadManifest(i._motionManifest),c.addEventListener("complete",l,!1),c.addEventListener("error",function(t){console.log("Error when loading motion:",t.title,t.message),a()},!1)):l()})})},document.registerElement("otp-faction",{prototype:o});var d=function(){function t(i,n){e(this,t),this.$root=i,this._policy=n||function(t){return!0}}return a(t,[{key:"load",value:function(){var t=this;return new Promise(function(e,i){var n=0,a=!1;t.$root.find("otp-faction").each(function(i,o){n++,o.load(t._policy).then(function(){n--,a&&0===n&&e()})}),a=!0,0===n&&e()})}}]),t}();t.FactionPrototype=o,t.FactionLoader=d});