!function(t,e){if("function"==typeof define&&define.amd)define(["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var i={exports:{}};e(i.exports),t.faction=i.exports}}(this,function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=getComputedStyle(t),n=parseFloat(i.width),a=(parseFloat(i.height),0),o=e.scales.length;o>a;a++){var s=e.scales[a];Math.ceil(s*e.width/l/100);if(!(o-1>a))return s;var r=e.scales[a+1],d=Math.ceil(r*e.width/l/100);if(-1>d-n)return s}}function n(t,e){var i=l,n=$(t),a=n.width(),o=n.height(),s=i*a*e.scale,r=i*o*e.scale;return Math.max(s/e.stage.width,r/e.stage.height)}function a(t){return new Promise(function(e,i){var n=document.createElement("script");n.async="async",n.addEventListener("load",function(){e()},!1),n.src=t,document.getElementsByTagName("head")[0].appendChild(n)})}function o(){return c?c:window.createjs?(c||(createjs.LoadItem.LOAD_TIMEOUT_DEFAULT=8e5,c=Promise.resolve()),c):c=a(d)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),r=Object.create(HTMLElement.prototype),d="//code.createjs.com/createjs-2015.11.26.min.js";Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,i=Object(this),n=i.length>>>0,a=arguments[1],o=0;n>o;o++)if(e=i[o],t.call(a,e,o,i))return e}),r.createdCallback=function(){this._loadCount=0,this._appliedScale=null,this._bitmaps={},this._sprites={}},r.scaleModifier="@",r.readAttributes=function(){this.base=this.getAttribute("base"),this.name=this.getAttribute("name"),this.kind=this.getAttribute("kind")||"image",this.scaleModifier=this.getAttribute("scale-modifier")||r.scaleModifier;var t=this.getAttribute("stay");null!=t&&(t=""===t||"true"===t?0:parseInt(t),this._stayPosition=t)},r.attributeChangedCallback=function(t,e,i){if(!(this._loadCount<=0)){$(this);switch(t){case"base":$(this).empty(),this.base=i,this.load();break;case"name":$(this).empty(),this.name=i,this.load();break;case"kind":$(this).empty(),this._oldKind=this.kind,this.kind=i,this.load();break;case"stay":this._stayPosition=i,null!=i&&(i=""===i||"true"===i?0:parseInt(i),this._stayPosition=i)}}};var c,l=parseInt(window.devicePixelRatio||1);r.play=function(t,e){switch(this.kind){case"motion":this.scene&&(void 0!==t?this.scene.gotoAndPlay&&this.scene.gotoAndPlay(t):this.scene.play&&this.scene.play());break;default:console.warn("Not supported play function in this kind:",this.kind)}},r.stop=function(t){switch(this.kind){case"motion":this.scene&&this.scene.gotoAndStop&&this.scene.gotoAndStop(t);break;default:console.warn("Not supported stop function in this kind:",this.kind)}},r.load=function(t){this.readAttributes();var e=$(this),a=this;return t&&!t(e)?Promise.resolve():(this._loadCount+=1,new Promise(function(t,o){var s=window.metadata&&window.metadata.factions?window.metadata.factions.find(function(t){return t.name==a.name&&t.base==a.base})||{}:{};switch(a.kind){case"image":var r=i(a,s.image);if(a._appliedScale>=r&&(a.kind==a._oldKind||!a._oldKind))return void t();a._appliedScale=r,e.children().filter(".otp-canvas").attr("otp-state","retired");var d=$('<img class="otp-canvas otp-image-canvas">'),c=a.getImageUrl(a.base,a.name,r,s.image.ext);d.on("load",function(){e.children().filter(".otp-canvas[otp-state=retired]").remove(),t()}).on("error",function(){t()}).attr({src:c}),e.prepend(d);break;case"background":var r=i(a,s.image);if(a._appliedScale>=r&&(a.kind==a._oldKind||!a._oldKind))return void t();var d=$("<img>"),c=a.getImageUrl(a.base,a.name,r,s.image.ext);d.on("load",function(){t()}).on("error",function(){t()}).attr({src:c}),e.css({"background-image":"url("+c+")"}),a._appliedScale=r;break;case"motion":if(a._appliedScale>=r&&(a.kind==a._oldKind||!a._oldKind))return void t();var l=s.motion;if(l&&l.stage){var r=n(a,l),h=e.find(".otp-motion-canvas");if(h.length>0)if(h.attr({width:Math.round(l.stage.width*r/100),height:Math.round(l.stage.height*r/100),"otp-stage-width":l.stage.width,"otp-stage-height":l.stage.height}),100*a.stage.scaleX>=r)a.stage.scaleX=a.stage.scaleY=r/100;else{a.stage.scaleX=a.stage.scaleY=r/100;var f=a._loadCount;a.loadUpdatedMotionImages(s,r).then(function(t){if(!(a._loadCount>f))for(var e=0,i=t.length;i>e;e++){var n=t[e],o=s.motion.images[n.id],r=new createjs.Event("changed");if(s.motion.atlases){var d=s.motion.atlases[n.id];if(d){var c=a._sprites[n.id],l=o.ewidth/n.img.width,h={images:{},frames:a.getScaledFramesBounds(d.frames,1/l)};h.images.push(n.img),c.spriteSheet=new createjs.SpriteSheet(h),r.set({scale:l}),c.dispatchEvent(r)}}else{var u=a._bitmaps[n.id],l=o.ewidth/n.img.width;u.image=n.img,r.set({scale:l}),u.dispatchEvent(r)}}})}else a._motionLoading||(e.children().filter(".otp-canvas").attr("otp-state","retired"),a.loadMotion(s,r).then(function(){e.children().filter(".otp-canvas[otp-state=retired]").remove();var i=$('<canvas class="otp-canvas otp-motion-canvas">').attr({width:Math.round(l.stage.width*r/100),height:Math.round(l.stage.height*r/100),"otp-stage-width":l.stage.width,"otp-stage-height":l.stage.height}).appendTo(e);a.stage=new createjs.Stage(i[0]),a.scene=new(l.library[a.name.replace(/\-/g,"")]),a.stage.addChild(a.scene),a.stage.scaleX=a.stage.scaleY=r/100,a.stage.update(),createjs.Ticker.addEventListener("tick",a.stage),void 0!=a._stayPosition&&a.stop(a._stayPosition),t()}))}else console.error("ERROR:Not found stage object:",this.base);a._appliedScale=r;break;default:console.error("Not support faction kind: ",a.kind)}}))},r.loadMotionLibs=function(){return this._motionLibsPromise||(this._motionLibsPromise=Promise.all([o(),a(getMotionLibUrl(this.base,this.name))])),this._motionLibsPromise},r.loadUpdatedMotionImages=function(t,e){var i=[],n=this;return new Promise(function(a,o){for(var s=0,r=n._motionManifest.length;r>s;s++){var d=n._motionManifest[s],c=n.getMotionManifestItem(t,d.id,e);d.scale<c.scale&&i.push(c)}if(i.length>0)for(var l=0,h=i.length,f=function(t){var e=new Image;e.addEventListener("load",function(){n._motionManifest[n._motionManifest.indexOf(n.findMotionMftItem(t.id))]=t,t.img=this,++l==h&&a(i)},!1),e.src=t.src},s=0,r=i.length;r>s;s++)f(i[s]);else a([])})},r.buildMotionManifest=function(t,e){var i=[];for(var n in t.motion.images)i.push(this.getMotionManifestItem(t,n,e));return i},r.getMotionManifestItem=function(t,e,i){for(var n=t.motion.images[e],a=n.scales,o=100,s=(n.width,i*n.ewidth/100),r=0,d=a.length;d>r;r++){var c=a[r],l=a[r+1];if(null==l||l*n.width/100-s<-1){o=c;break}}return{src:this.getImageUrl(this.base+"/"+this.name+".anim",e,o,n.ext),id:e,scale:o}},r.getImageUrl=function(t,e,i,n){return"/"!=t[t.length-1]&&(t+="/"),""+t+e+this.scaleModifier+i+"p"+n},r.getMotionLibUrl=function(t,e){return"/"!=t[t.length-1]&&(t+="/"),t+"/"+e+".anim/"+e+".js"},r.buildBitmapDefine=function(t,e,i,n,a){var o=new createjs.Bitmap(n),s=new createjs.MovieClip;o.nominalBounds=s.nominalBounds=new(Function.prototype.bind.call(createjs.Rectangle,null,i)),this._bitmaps[e]=o;var r=function(){};r.prototype=o,(t[e]=function(){var t=new r;t.setTransform(0,0,a,a),o.addEventListener("changed",function(e){t.setTransform(0,0,e.scale/a,e.scale/a)}),this.addChild(t)}).prototype=s},r.buildSpriteDefine=function(t,e,i,n,a){var o=new createjs.Sprite,s=new createjs.MovieClip;this._sprites[e]=o;var r=function(){this.spriteSheet=n,this.gotoAndStop(i)};r.prototype=o,(t[e]=function(){var t=new r;t.setTransform(0,0,a,a),this.addChild(t),o.addEventListener("changed",function(e){t.setTransform(0,0,e.scale,e.scale)})}).prototype=s},r.findMotionMftItem=function(t){for(var e,i=0,n=this._motionManifest.length;n>i;i++){var a=this._motionManifest[i];if(a.id==t){e=a;break}}return e},r.getScaledFramesBounds=function(t,e){for(var i=[],n=0,a=t.length;a>n;n++){var o=t[n];i.push([o[0]*e,o[1]*e,o[2]*e,o[3]*e])}return i},r.loadMotion=function(t,e){if(this._motionPromise)return this._motionPromise;var i=this;return i._motionLoading=!0,this._motionPromise=new Promise(function(n,a){i.loadMotionLibs().then(function(){var o=t.motion,s=o.library,r=(s.properties,{}),d={},c=new createjs.LoadQueue(!1);i._motionManifest=i.buildMotionManifest(t,e),c.loadManifest(i._motionManifest),c.addEventListener("complete",function(t){if(i._motionLoading=!1,o.atlases)for(var e in o.atlases){var a=o.atlases[e],l=(a.sprites,i.findMotionMftItem(e)),h=o.images[e],f=h.width*l.scale/100/h.ewidth,u={images:[],frames:i.getScaledFramesBounds(a.frames,f)};u.images.push(c.getResult(e)),d[e]=new createjs.SpriteSheet(u);for(var m=o.atlases[e].sprites,p=0,g=m.length;g>p;p++)i.buildSpriteDefine(s,m[p],p,d[e],1/f)}else{for(var p=0,g=i._motionManifest.length;g>p;p++){var l=i._motionManifest[p];r[l.id]=c.getResult(l.id)}if(o.bitmaps)for(var e in o.bitmaps){var l=i.findMotionMftItem(e),h=o.images[e],f=h.width*l.scale/100/h.ewidth;i.buildBitmapDefine(s,e,o.bitmaps[e].bounds,r[e],1/f)}}o.initLibrary(s,createjs),n()},!1),c.addEventListener("error",function(t){console.log("Error when loading motion:",t.title,t.message),a()},!1)})})},document.registerElement("otp-faction",{prototype:r});var h=function(){function t(i,n){e(this,t),this.$root=i,this._policy=n||function(t){return!0}}return s(t,[{key:"load",value:function(){var t=this;return new Promise(function(e,i){var n=0,a=!1;t.$root.find("otp-faction").each(function(i,o){n++,o.load(t._policy).then(function(){n--,a&&0===n&&e()})}),a=!0,0===n&&e()})}}]),t}();t.FactionPrototype=r,t.FactionLoader=h});