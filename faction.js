"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var i={exports:{}};e(i.exports),t.faction=i.exports}}(this,function(t){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=getComputedStyle(t),s=parseFloat(i.width),n=(parseFloat(i.height),0),a=e.scales.length;a>n;n++){var o=e.scales[n];Math.ceil(o*e.width/c/100);if(!(a-1>n))return o;var r=e.scales[n+1],h=Math.ceil(r*e.width/c/100);if(s>h)return o}}function s(t,e){var i=c,s=$(t),n=s.width(),a=s.height(),o=i*n*e.scale,r=i*a*e.scale;return Math.max(o/e.stage.width,r/e.stage.height)}function n(t){var e=document.createElement("script"),i=$.Deferred();return e.async="async",e.addEventListener("load",function(){i.resolve()},!1),e.src=t,document.getElementsByTagName("head")[0].appendChild(e),i}function a(){if(d)return d;if(window.createjs){if(!d){var t=$.Deferred();t.resolve(),createjs.LoadItem.LOAD_TIMEOUT_DEFAULT=8e5,d=t.promise()}return d}return d=n(h)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),r=Object.create(HTMLElement.prototype),h="//code.createjs.com/createjs-2015.11.26.min.js";r.createdCallback=function(){this._loadCount=0,this._appliedScale=null,this._bitmaps={},this._sprites={}},r.readAttributes=function(){this.base=this.getAttribute("base"),this.kind=this.getAttribute("kind")||"image",this.width=this.getAttribute("width"),this.height=this.getAttribute("height");var t=this.getAttribute("stay");null!=t&&(t=""===t||"true"===t?0:parseInt(t),this._stayPosition=t)},r.attributeChangedCallback=function(t,e,i){if(!(this._loadCount<=0)){var s=$(this);switch(t){case"base":$(this).empty(),this.base=i,this.load();break;case"kind":$(this).empty(),this._oldKind=this.kind,this.kind=i,this.load();break;case"stay":this._stayPosition=i,null!=i&&(i=""===i||"true"===i?0:parseInt(i),this._stayPosition=i),this.stop(this._stayPosition);case"width":switch(this.kind){case"image":s.find("img").attr("width",this.width);break;case"background":this.height?s.css({"background-size":this.width+"px "+this.height+"px"}):s.css({"background-size":this.width+"px"})}case"height":switch(this.kind){case"image":$(this).find("img").attr("height",this.height);break;case"background":this.width?$(this).css({"background-size":this.width+"px "+this.height+"px"}):$(this).css({"background-size":"auto "+this.height+"px"})}}}};var d,c=parseInt(window.devicePixelRatio||1);r.play=function(t,e){switch(this.kind){case"motion":void 0!==pos?this.scene.gotoAndPlay(t):this.scene.play();break;default:console.warn("Not supported play function in this kind:",this.kind)}},r.stop=function(t){switch(this.kind){case"motion":this.scene.gotoAndStop(t);break;default:console.warn("Not supported stop function in this kind:",this.kind)}},r.load=function(t){this.readAttributes();var e=$.Deferred(),n=$(this);if(t&&!t(n))return e.resolve(),e.promise();var a=(++this._loadCount,this),o=window.metadata.factions&&this.base?window.metadata.factions[this.base]||{}:{};switch(o.image.scales.sort(function(t,e){return t>e?-1:1}),this.kind){case"image":var r=i(this,o.image);if(this._appliedScale>=r&&this.kind==this._oldKind)return e.resolve(),e.promise();this._appliedScale=r,n.children().attr("otp-state","retired");var h=$('<img class="otp-canvas">'),d=this.base+"/"+o.name+"@"+r+"p."+o.image.extension;h.on("load",function(){n.find("[otp-state=retired]").remove(),e.resolve()}).on("error",function(){e.resolve()}).attr({width:this.width,height:this.height,src:d}),n.prepend(h);break;case"background":var r=i(this,o.image);if(this._appliedScale>=r&&this.kind==this._oldKind)return e.resolve(),e.promise();var h=$("<img>"),d=this.base+"/"+o.name+"@"+r+"p."+o.image.extension;h.on("load",function(){e.resolve()}).on("error",function(){e.resolve()}).attr({src:d}),this.width&&(this.height?n.css({"background-size":this.width+"px "+this.height+"px"}):n.css({"background-size":this.width+"px"})),n.css({"background-image":"url("+d+")"}),this._appliedScale=r;break;case"motion":if(this._appliedScale>=r&&this.kind==this._oldKind)return e.resolve(),e.promise();var c=o.motion;if(!c)throw"No motion data found!";var r=s(this,c),l=n.find("canvas[otp-motion-canvas]");l.length>0?(l.attr({width:Math.round(c.stage.width*r/100),height:Math.round(c.stage.height*r/100),"otp-stage-width":c.stage.width,"otp-stage-height":c.stage.height}),a.stage.scaleX=a.stage.scaleY=r/100,a.loadUpdatedMotionImages(o,r).then(function(t){for(var e=0,i=t.length;i>e;e++){var s=t[e],n=o.motion.images[s.id],r=new createjs.Event("changed");if(o.motion.atlases){var h=o.motion.atlases[s.id];if(h){var d=a._sprites[s.id],c=n.ewidth/s.img.width,l={images:{},frames:a.getScaledFramesBounds(h.frames,1/c)};l.images.push(s.img),d.spriteSheet=new createjs.SpriteSheet(l),r.set({scale:c}),d.dispatchEvent(r)}}else{var f=a._bitmaps[s.id],c=n.ewidth/s.img.width;f.image=s.img,r.set({scale:c}),f.dispatchEvent(r)}}})):a._motionLoading||(n.children().attr("otp-state","retired"),this.loadMotion(o,r).then(function(){n.find("[otp-state=retired]").remove();var t=$("<canvas otp-motion-canvas>").attr({width:Math.round(c.stage.width*r/100),height:Math.round(c.stage.height*r/100),"otp-stage-width":c.stage.width,"otp-stage-height":c.stage.height}).appendTo(n);a.stage=new createjs.Stage(t[0]),a.scene=new c.library[o.name],a.stage.addChild(a.scene),a.stage.scaleX=a.stage.scaleY=r/100,a.stage.update(),createjs.Ticker.addEventListener("tick",a.stage),e.resolve()})),this._appliedScale=r;break;default:console.error("Not support faction kind: ",this.kind)}return e.promise()},r.loadMotionLibs=function(t){return this._motionLibsPromise||(this._motionLibsPromise=$.when(a(),n(this.base+"/motion/"+t.name+".js"))),this._motionLibsPromise},r.loadUpdatedMotionImages=function(t,e){this._loadUpdatedMotionImagesDeferred&&"pending"==this._loadUpdatedMotionImagesDeferred.state()&&this._loadUpdatedMotionImagesDeferred.reject();for(var i=(this._loadUpdatedMotionImagesDeferred=$.Deferred(),[]),s=this,n=0,a=this._motionManifest.length;a>n;n++){var o=this._motionManifest[n],r=this.getMotionManifestItem(t,o.id,e);o.scale<r.scale&&i.push(r)}if(i.length>0)for(var h=0,d=i.length,c=function(t){var e=new Image;e.addEventListener("load",function(){s._motionManifest[s._motionManifest.indexOf(s.findMotionMftItem(t.id))]=t,t.img=this,++h==d&&s._loadUpdatedMotionImagesDeferred.resolve(i)},!1),e.src=t.src},n=0,a=i.length;a>n;n++)c(i[n]);else this._loadUpdatedMotionImagesDeferred.resolve([]);return this._loadUpdatedMotionImagesDeferred.promise()},r.buildMotionManifest=function(t,e){var i=[];for(var s in t.motion.images)i.push(this.getMotionManifestItem(t,s,e));return i},r.getMotionManifestItem=function(t,e,i){for(var s=t.motion.images[e],n=s.scales,a=100,o=i/(s.width/s.ewidth),r=0,h=n.length;h>r;r++){var d=n[r],c=n[r+1];if(d>=o&&(null==c||o>c)){a=d;break}}return{src:this.base+"/motion/images/"+e+"@"+a+"p."+s.extension,id:e,scale:a}},r.buildBitmapDefine=function(t,e,i,s,n){var a=new createjs.Bitmap(s),o=new createjs.MovieClip;a.nominalBounds=o.nominalBounds=new(Function.prototype.bind.call(createjs.Rectangle,null,i)),this._bitmaps[e]=a;var r=function(){};r.prototype=a,(t[e]=function(){var t=new r;t.setTransform(0,0,n,n),a.addEventListener("changed",function(e){t.setTransform(0,0,e.scale/n,e.scale/n)}),this.addChild(t)}).prototype=o},r.buildSpriteDefine=function(t,e,i,s,n){var a=new createjs.Sprite,o=new createjs.MovieClip;this._sprites[e]=a;var r=function(){this.spriteSheet=s,this.gotoAndStop(i)};r.prototype=a,(t[e]=function(){var t=new r;t.setTransform(0,0,n,n),this.addChild(t),a.addEventListener("changed",function(e){t.setTransform(0,0,e.scale,e.scale)})}).prototype=o},r.findMotionMftItem=function(t){for(var e,i=0,s=this._motionManifest.length;s>i;i++){var n=this._motionManifest[i];if(n.id==t){e=n;break}}return e},r.getScaledFramesBounds=function(t,e){for(var i=[],s=0,n=t.length;n>s;s++){var a=t[s];i.push([a[0]*e,a[1]*e,a[2]*e,a[3]*e])}return i},r.loadMotion=function(t,e){if(this._motionPromise)return this._motionPromise;var i=$.Deferred(),s=this;return this._motionPromise=i.promise(),this.loadMotionLibs(t).then(function(){var n=t.motion,a=n.library,o=(a.properties,{}),r={},h=new createjs.LoadQueue(!1);s._motionLoading=!0,h.addEventListener("complete",function(t){if(s._motionLoading=!1,n.atlases)for(var e in n.atlases){var d=n.atlases[e],c=(d.sprites,s.findMotionMftItem(e)),l=n.images[e],f=l.width*c.scale/100/l.ewidth,u={images:[],frames:s.getScaledFramesBounds(d.frames,f)};u.images.push(h.getResult(e)),r[e]=new createjs.SpriteSheet(u);for(var p=n.atlases[e].sprites,m=0,g=p.length;g>m;m++)s.buildSpriteDefine(a,p[m],m,r[e],1/f)}else{for(var m=0,g=s._motionManifest.length;g>m;m++){var c=s._motionManifest[m];o[c.id]=h.getResult(c.id)}if(n.bitmaps)for(var e in n.bitmaps){var c=s.findMotionMftItem(e),l=n.images[e],f=l.width*c.scale/100/l.ewidth;s.buildBitmapDefine(a,e,n.bitmaps[e].bounds,o[e],1/f)}}n.initLibrary(a,createjs),i.resolve()},!1),h.addEventListener("error",function(t){console.log("Error when loading motion:",t.title,t.message),i.reject()},!1),s._motionManifest=s.buildMotionManifest(t,e),h.loadManifest(s._motionManifest)}),this._motionPromise},document.registerElement("otp-faction",{prototype:r});var l=function(){function t(i,s){e(this,t),this.$root=i,this._policy=s||function(t){return!0}}return o(t,[{key:"load",value:function(){var t=this,e=0,i=!1,s=$.Deferred();return this.$root.find("otp-faction").each(function(n,a){e++,a.load(t._policy).then(function(){e--,i&&0===e&&s.resolve()})}),i=!0,0===e&&s.resolve(),s.promise()}}]),t}();t.FactionPrototype=r,t.FactionLoader=l});